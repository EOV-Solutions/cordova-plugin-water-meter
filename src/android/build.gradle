ext {
    // SDK version
    minSdkVersion = 23
    compileSdkVersion = 29
    targetSdkVersion = 29
}

// Fix for native library loading in release builds / App Bundles
android {
    packagingOptions {
        // Ensure native libraries are extracted (required for older devices and some ABIs)
        jniLibs {
            useLegacyPackaging = true
        }
        // Prevent duplicate .so files if multiple AARs have same libraries
        pickFirst '**/libc++_shared.so'
    }
}

repositories {
    google()
    mavenCentral()
}

// Auto-copy AAR to app/libs (Cordova workaround)
// AAR is in plugins/cordova-plugin-water-meter/libs/ after "cordova plugin add"
task copyAarToAppLibs {
    doLast {
        // Path from platforms/android/app/ to plugins/cordova-plugin-water-meter/libs/
        def aarSource = project.file('../../../plugins/cordova-plugin-water-meter/libs/water_meter_sdk.aar')
        def appLibsDir = new File(project.projectDir, 'libs')
        def aarTarget = new File(appLibsDir, 'water_meter_sdk.aar')
        
        if (aarSource.exists()) {
            appLibsDir.mkdirs()
            aarTarget.bytes = aarSource.bytes
            println "✓ Copied AAR from plugins: ${aarSource} -> ${aarTarget}"
        } else {
            println "⚠ AAR not found at: ${aarSource}"
            println "   Current project dir: ${project.projectDir}"
        }
    }
}

// Run before preBuild
project.afterEvaluate {
    preBuild.dependsOn copyAarToAppLibs
}

dependencies {
    // Auto-load AAR from libs folder
    implementation fileTree(dir: 'libs', include: ['*.jar', '*.aar'])
    
    // Or explicitly reference the AAR (alternative method)
    // implementation files('libs/water_meter_sdk.aar')
    
    // AndroidX
    implementation 'androidx.appcompat:appcompat:1.3.1'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.0'
    
    // Camera2
    implementation 'androidx.camera:camera-core:1.0.2'
    implementation 'androidx.camera:camera-camera2:1.0.2'
    implementation 'androidx.camera:camera-lifecycle:1.0.2'
    implementation 'androidx.camera:camera-view:1.0.0-alpha27'
    
    // OpenCV (if SDK needs it externally)
    // implementation 'org.opencv:opencv-android:4.2.0'
}
